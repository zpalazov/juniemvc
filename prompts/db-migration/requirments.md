# DB Migration Requirements for Junie (Spring Boot + Flyway)

## 1. Goal and Scope
- Introduce initial database schema managed by Flyway for the Junie application. The schema must reflect the current JPA model:
  - BeerEntity (table: beers)
  - BeerOrderEntity (table: beer_orders)
  - BeerOrderLineEntity with composite key BeerOrderLineId (table: beer_order_lines)
- Relationships (as per ERD and entities):
  - BeerOrder 1 —* BeerOrderLine
  - Beer 1 —* BeerOrderLine
- Deliver a versioned SQL migration file named V1__Initial_DB.sql implementing the full schema.

## 2. Conventions and Design Decisions
- IDs: INTEGER with identity/auto-increment semantics where applicable (BeerEntity.id, BeerOrderEntity.id). The BeerOrderLineEntity uses a composite primary key of (beer_order_id, beer_id) from the embeddable BeerOrderLineId.
- Timestamps: map LocalDateTime fields to TIMESTAMP WITHOUT TIME ZONE columns named created_date (not updatable) and updated_date.
- Enums: persist as STRING using @Enumerated(EnumType.STRING):
  - BeerOrderStatus: NEW, VALIDATION_PENDING, VALIDATED, ALLOCATION_PENDING, ALLOCATED, PICKED_UP, DELIVERED, CANCELLED
  - BeerOrderLineStatus: NEW, ALLOCATED, CANCELLED
- Naming: snake_case for columns, plural table names; align with existing entities (beers, beer_orders, beer_order_lines).
- Precision/scale: monetary decimal columns use DECIMAL(19,2).
- Indexing: create functional indexes to support lookups on foreign keys and business keys per entities.
- Constraints first-class: primary keys, foreign keys, not nulls, unique constraints per model.

## 3. Target Schema (authoritative mapping)

### 3.1 beers
- Columns:
  - id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY (or AUTO_INCREMENT depending on DB)
  - version INT NULL
  - name VARCHAR(255) NOT NULL
  - style VARCHAR(255) NOT NULL
  - upc VARCHAR(255) NOT NULL UNIQUE
  - quantity_on_hand INT NULL
  - price DECIMAL(19,2) NOT NULL
  - created_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  - update_date TIMESTAMP NULL
- Indexes/constraints:
  - Unique constraint on upc (consistent with @Column(unique = true))

Notes:
- Column update_date follows the entity name updateDate.

### 3.2 beer_orders
- Columns:
  - id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
  - version INT NULL
  - customer_ref VARCHAR(255) NOT NULL
  - payment_amount DECIMAL(19,2) NULL
  - status VARCHAR(64) NOT NULL  -- stores BeerOrderStatus as STRING
  - created_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  - updated_date TIMESTAMP NULL
- Indexes:
  - idx_beer_orders_customer_ref on (customer_ref)

### 3.3 beer_order_lines
- Primary Key: composite (beer_order_id, beer_id) to match @EmbeddedId BeerOrderLineId
- Columns:
  - beer_order_id INT NOT NULL
  - beer_id INT NOT NULL
  - version INT NULL
  - order_quantity INT NOT NULL
  - status VARCHAR(64) NOT NULL  -- stores BeerOrderLineStatus as STRING
  - created_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
  - updated_date TIMESTAMP NULL
- Constraints:
  - PK (beer_order_id, beer_id)
  - FK beer_order_id -> beer_orders(id) ON DELETE CASCADE
  - FK beer_id -> beers(id)
- Indexes:
  - idx_bol_order on (beer_order_id)
  - idx_bol_beer on (beer_id)

Rationale:
- The entity models a line identified by order and beer; there is no separate surrogate ID field in BeerOrderLineEntity.
- Cascade and orphanRemoval are configured on the parent entity; ON DELETE CASCADE on beer_order_id aligns with removal of lines when orders are deleted.

## 4. Migration File Requirements (V1__Initial_DB.sql)
- Location: classpath: db/migration (src/main/resources/db/migration). Spring Boot + Flyway default.
- Filename: V1__Initial_DB.sql (double underscore after version).
- SQL content must:
  1. Create table beers per 3.1 including unique constraint on upc.
  2. Create table beer_orders per 3.2 including index idx_beer_orders_customer_ref.
  3. Create table beer_order_lines per 3.3 with composite PK, FKs and indexes (idx_bol_order, idx_bol_beer).
  4. Use explicit column names matching entities: created_date vs update_date/updated_date accordingly.
  5. Use proper data types compatible with the target RDBMS (H2/PostgreSQL/MySQL). Prefer ANSI types: INT, DECIMAL(19,2), TIMESTAMP, VARCHAR(…) to stay portable.
  6. Ensure idempotency by guarding CREATE statements using IF NOT EXISTS where supported by the target DB in dev (H2/Postgres support). If not using IF NOT EXISTS, rely on Flyway baseline and version control to avoid re-creation conflicts.
- Do not insert seed data in V1; keep schema-only. Seed data, if needed, will be added in Vx__*.sql later.

## 5. Acceptance Criteria
- Application starts successfully with Flyway running the V1 migration and creating all three tables.
- JPA schema validation (if enabled with spring.jpa.hibernate.ddl-auto=validate or none) passes against the Flyway-created schema.
- beer_orders.status and beer_order_lines.status store textual enum names; no numeric codes.
- UPC is unique in beers; inserting duplicate UPC fails with a constraint violation.
- Foreign keys enforce integrity: deleting a beer order cascades deletes to its lines; beers referenced by lines cannot be deleted without handling the references.
- Queries on beer_orders by customer_ref and on beer_order_lines by beer_order_id/beer_id are accelerated by indexes.

## 6. Testing and Config
- Spring Boot config recommendations:
  - spring.jpa.open-in-view=false
  - spring.jpa.hibernate.ddl-auto=none or validate (Flyway controls schema)
  - Flyway enabled by default via dependency.
- Local dev DB can be H2 (file or memory) or Postgres via Testcontainers for integration tests.
- Optional integration test should verify migration and basic CRUD roundtrip for Beer/Order/OrderLine.

## 7. Future Migrations
- Do not edit V1 after it’s applied; create new versioned scripts V2__..., V3__... for changes.
- For enum changes, widen varchar length if needed and rely on STRING storage stability.
- Keep migrations small and idempotent; add repeatable scripts R__… for views or seed data if later required.

## 8. Deliverables
- File: src/main/resources/db/migration/V1__Initial_DB.sql containing the schema as specified.
- This requirements document: prompts/db-migration/requirments.md (this file).

## 9. Notes and Alignments
- Aligns with Kotlin/Spring Boot guidelines: constructor safety, restricted visibility, separation of web/persistence, explicit DTOs, and Flyway usage (see .junie/guidelines.md).
- Naming alignment specifics from entities:
  - beers.update_date (note: BeerEntity uses updateDate; column name is update_date per entity mapping)
  - beer_orders.created_date and updated_date
  - beer_order_lines.created_date and updated_date
